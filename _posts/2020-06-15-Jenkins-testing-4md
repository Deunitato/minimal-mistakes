---
published: false
---
# Things done today
- Venv in main directory
- git push only yaml and docker
- pytest
- Swagger


Original jenkins file:
```groovy

def namespace = "default"
pipeline {

    environment{
     PROJECT_TITLE = 'science-experiments-divya'
     APP_NAME = 'taxonomy'

     APP_TAG = "0.1.${env.BUILD_NUMBER}" //change this to $env.BRANCH_NAME or $env.BUILD_NUMBER
     CLUSTER = "cluster-1"
     CLUSTER_ZONE = "asia-southeast1-a"
     IMAGE_TAG = "gcr.io/${PROJECT_TITLE}/${APP_NAME}:${APP_TAG}"

     JENKINS_CRED = "${PROJECT_TITLE}"
     GOOGLE_APPLICATION_CREDENTIALS = credentials('gcp_service_account_key_sentient');
     GIT_CREDENTIAL_ID = credentials('github-divya')
     GIT_URL = 'science-experiements-divya/taxanomy-trial-jenkins'
     IS_PYTHON_EXIST = fileExists 'Python-3.7.7'
     IS_ENV_EXIST = fileExists '../../.env'
     IS_ALFRED_EXIST = fileExists 'Alfred'

    }
agent any
  stages {
      stage('Get python package'){
        when { expression { IS_PYTHON_EXIST == 'false' } }
        steps{
          sh"""
              cd ..
              apt-get -y update
              apt install -y build-essential wget zlib1g-dev libncurses5-dev libgdbm-dev libnss3-dev libssl-dev libreadline-dev libffi-dev
              wget https://www.python.org/ftp/python/3.7.7/Python-3.7.7.tgz
              tar -xf Python-3.7.7.tgz
          """
        }
      }
      
      stage ('Installing python'){
        when { expression { IS_PYTHON_EXIST == 'false' } }
        steps{
            sh """
                  apt -y install python3-pip
                  apt -y install python-pip
                  cd Python-3.7.7
                  ./configure --enable-optimizations
                  make altinstall
                  ls
                  """
                  sh 'python3.7 --version'
        }
      }

      stage("Attempt start at virtual environment"){
        when { expression { IS_ENV_EXIST == 'false' } }
        steps{
          sh """
              python3.7 -m pip install virtualenv
              python3.7 -m venv env
          """
        }
      }
      stage("Fetch Alfred"){
        when { expression { IS_ALFRED_EXIST == 'false' } }
        steps {
                withCredentials([usernamePassword(credentialsId: 'github-divya', usernameVariable: 'USER', passwordVariable: 'PASS')]) 
                {
                    sh """
                    ls
                    virtualenv .env
                    source .env/bin/activate
                    git config user.name "${USER}"
                    git config user.email "${USER}@gmail.com"
                    git clone https://${USER}:${PASS}@github.com/science-experiements-divya/alfredtest.git
                    cp -r alfredtest/Alfred ./
                    """
                } 
            }
      }

      stage("Installing Alfred"){
        steps{
          sh """
              virtualenv .env
              source .env/bin/activate
              cd deploy/scripts
              python3.7 -m pip install -r alfred-requirements.txt
              """
          sh """
              ls
              virtualenv .env
              source .env/bin/activate
              cd Alfred
              python3.7 -m pip install --ignore-installed -e .
          """
        }
      }
      stage('Running Alfred_script'){
          steps{
               // dir("env"){
                  sh """
                  virtualenv .env
                  source .env/bin/activate
                  cd deploy
                  python3.7 scripts/Alfred_script.py
                """
          }
      }

      stage("Attempt trigger other job"){
        steps {
          build job: 'microservice/testing-pipeline', propagate: true, wait: true
        }
      }

      // stage('Create Branch & Push Branch') {
      //       steps {

      //           withCredentials([usernamePassword(credentialsId: 'github-divya', usernameVariable: 'USER', passwordVariable: 'PASS')]) 
      //           {
      //               sh """
      //               git config user.name "${USER}"
      //               git config user.email "${USER}@gmail.com"
      //               git checkout -b output/${APP_TAG}
      //               git add .
      //               git commit -m "update repo"
      //               git push https://${USER}:${PASS}@github.com/science-experiements-divya/alfred-pipeline-test.git
      //               """
                    
      //           } 
      //       }
      // }

  }
  // post {
  //   always {
  //     dir("${env.WORKSPACE}@tmp") {
  //       deleteDir()
  //     }
  //     dir("${env.WORKSPACE}@script") {
  //       deleteDir()
  //     }
  //     dir("${env.WORKSPACE}@script@tmp") {
  //       deleteDir()
  //     }
  //   }
  // }
}
```


# Venv in main directory
1. Configure global paths

2. Add the `${env.WORKSPACE_DIR}` in the code

Envirnoment snippet:
```
    environment{
     IS_PYTHON_EXIST = fileExists "/${env.WORKSPACE_DIR}/Python-3.7.7"
     IS_ENV_EXIST = fileExists "/${env.WORKSPACE_DIR}/.env"
     IS_ALFRED_EXIST = fileExists "/${env.WORKSPACE_DIR}/Alfred"

    }
```

Installing virtual Environment:
```
      stage("Attempt start at virtual environment"){
        when { expression { IS_ENV_EXIST == 'false' } }
        steps{
           dir("${env.WORKSPACE_DIR}"){
            sh """
                ls
                python3.7 -m pip install virtualenv
                python3.7 -m venv env
            """
           }
        }
      }
```

Resource: [Global environment](https://dzone.com/articles/jenkins-02-changing-home-directory)